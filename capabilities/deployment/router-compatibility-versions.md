# Router Compatibility Versions

## Metadata

| Field | Value |
|-------|-------|
| **Capability ID** | `cap-deploy-007` |
| **Category** | Deployment |
| **Status** | GA |
| **Availability** | Free / Pro / Enterprise |
| **Related Capabilities** | `cap-deploy-001`, `cap-deploy-008` |

---

## Quick Reference

### Name
Router Compatibility Versions

### Tagline
Safe upgrades with version handshake protection.

### Elevator Pitch
Router Compatibility Versions ensure that your router and its execution configuration are always compatible. When breaking changes occur between composition and router execution, Cosmo manages versioned configurations so routers only receive compatible configurations. Upgrade routers confidently knowing incompatible configurations will be rejected.

---

## Problem & Solution

### The Problem
In a federated architecture, the router depends on execution configurations generated by the composition process. Breaking changes between how configurations are structured and how routers interpret them can cause production incidents. Teams need a way to upgrade routers and compositions safely without risking incompatibility.

### The Solution
Cosmo implements a version handshake between router execution configurations and routers. Each configuration includes a `compatibilityVersion` that the router validates at startup. If the version exceeds the router's threshold, it produces an error and refuses to start. This prevents running routers with incompatible configurations.

### Before & After

| Before Compatibility Versions | With Compatibility Versions |
|------------------------------|----------------------------|
| Risk of incompatible configs | Version handshake validation |
| Silent configuration failures | Clear error messages on mismatch |
| Complex upgrade coordination | Safe incremental upgrades |
| Single configuration storage | Versioned configuration storage |

---

## Key Benefits

1. **Safe Upgrades**: Version handshake prevents routers from running incompatible configurations
2. **Clear Failure Mode**: Routers fail fast with explicit error messages when versions mismatch
3. **Independent Storage**: Different router compatibility versions stored at separate CDN addresses
4. **Gradual Migration**: Run routers on different versions simultaneously during migrations
5. **Backwards Compatibility**: Older configurations remain accessible for routers that haven't upgraded

---

## Target Audience

### Primary Persona
- **Role**: Platform Engineer, SRE
- **Pain Points**: Risky upgrades, fear of configuration incompatibility, coordination overhead during migrations
- **Goals**: Confident, safe router upgrades with rollback capability

### Secondary Personas
- Release Engineers managing federation deployments
- DevOps Engineers automating upgrade pipelines
- Engineering Managers planning upgrade rollouts

---

## Use Cases

### Use Case 1: Safe Production Upgrade
**Scenario**: Upgrade production routers to support new federation features
**How it works**: Deploy new router version (with higher compatibility threshold) alongside existing routers, verify functionality, gradually shift traffic, retire old routers
**Outcome**: Zero-downtime upgrade with fallback option at each stage

### Use Case 2: Canary Deployment
**Scenario**: Test new router version with production traffic before full rollout
**How it works**: Deploy single new-version router to canary pool, monitor behavior, new router automatically receives version-appropriate configuration
**Outcome**: Real-world validation of new router version without affecting all traffic

### Use Case 3: Multi-Version Fleet Management
**Scenario**: Run different router versions across environments during extended migration
**How it works**: Staging runs newer router version, production runs previous version, each receives appropriate configuration version
**Outcome**: Flexible upgrade timeline with environment-appropriate configurations

---

## Technical Summary

### How It Works
When Cosmo composes a federated graph, it generates an execution configuration with a `compatibilityVersion` property (format: `<version>:<package-version>`). Each router version defines an internal compatibility threshold. At startup, the router validates that the configuration's version doesn't exceed its threshold. Cosmo Cloud stores configurations discretely by version, with routers polling the address matching their threshold.

### Key Technical Features
- Version property format: `<compatibility-version>:<composition-package-version>`
- Router startup validation with clear error messages
- Discrete storage per compatibility version
- Automatic routing of configuration requests by version
- CLI commands for version management and listing

### Integration Points
- Cosmo CDN for versioned configuration storage
- Router startup validation
- CLI commands: `wgc federated-graph version set`, `compatibility-version list`

### Requirements & Prerequisites
- Understanding of current router version and its compatibility threshold
- Awareness of when new compatibility versions are released
- Coordination plan for upgrades (if required)

---

## Documentation References

- Primary docs: `/docs/concepts/router-compatibility-versions`
- Upgrading the router: `/docs/router/upgrading-the-router`
- Router configuration: `/docs/router/configuration#execution-config`
- CLI reference: `/docs/cli/federated-graph`

---

## Keywords & SEO

### Primary Keywords
- Router compatibility versions
- Federation version management
- Router upgrade safety

### Secondary Keywords
- Configuration versioning
- Safe router upgrades
- Version handshake

### Related Search Terms
- Upgrade GraphQL router safely
- Federation configuration compatibility
- Router version management
